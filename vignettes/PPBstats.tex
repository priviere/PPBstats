%\VignetteIndexEntry{PPBstats}
%\VignetteEngine{knitr::knitr}

\documentclass{article}\usepackage[]{graphicx}\usepackage[]{color}
%% maxwidth is the original width if it is less than linewidth
%% otherwise use linewidth (to make sure the graphics do not exceed the margin)
\makeatletter
\def\maxwidth{ %
  \ifdim\Gin@nat@width>\linewidth
    \linewidth
  \else
    \Gin@nat@width
  \fi
}
\makeatother

\definecolor{fgcolor}{rgb}{0.345, 0.345, 0.345}
\newcommand{\hlnum}[1]{\textcolor[rgb]{0.686,0.059,0.569}{#1}}%
\newcommand{\hlstr}[1]{\textcolor[rgb]{0.192,0.494,0.8}{#1}}%
\newcommand{\hlcom}[1]{\textcolor[rgb]{0.678,0.584,0.686}{\textit{#1}}}%
\newcommand{\hlopt}[1]{\textcolor[rgb]{0,0,0}{#1}}%
\newcommand{\hlstd}[1]{\textcolor[rgb]{0.345,0.345,0.345}{#1}}%
\newcommand{\hlkwa}[1]{\textcolor[rgb]{0.161,0.373,0.58}{\textbf{#1}}}%
\newcommand{\hlkwb}[1]{\textcolor[rgb]{0.69,0.353,0.396}{#1}}%
\newcommand{\hlkwc}[1]{\textcolor[rgb]{0.333,0.667,0.333}{#1}}%
\newcommand{\hlkwd}[1]{\textcolor[rgb]{0.737,0.353,0.396}{\textbf{#1}}}%

\usepackage{framed}
\makeatletter
\newenvironment{kframe}{%
 \def\at@end@of@kframe{}%
 \ifinner\ifhmode%
  \def\at@end@of@kframe{\end{minipage}}%
  \begin{minipage}{\columnwidth}%
 \fi\fi%
 \def\FrameCommand##1{\hskip\@totalleftmargin \hskip-\fboxsep
 \colorbox{shadecolor}{##1}\hskip-\fboxsep
     % There is no \\@totalrightmargin, so:
     \hskip-\linewidth \hskip-\@totalleftmargin \hskip\columnwidth}%
 \MakeFramed {\advance\hsize-\width
   \@totalleftmargin\z@ \linewidth\hsize
   \@setminipage}}%
 {\par\unskip\endMakeFramed%
 \at@end@of@kframe}
\makeatother

\definecolor{shadecolor}{rgb}{.97, .97, .97}
\definecolor{messagecolor}{rgb}{0, 0, 0}
\definecolor{warningcolor}{rgb}{1, 0, 1}
\definecolor{errorcolor}{rgb}{1, 0, 0}
\newenvironment{knitrout}{}{} % an empty environment to be redefined in TeX

\usepackage{alltt}

% to draw on figure or create figures
\usepackage{tikz}
\usepackage{pstricks}

\usetikzlibrary{shapes,arrows}
\graphicspath{{./figures/}}
\usepackage{wrapfig}

\usepackage{multicol}

\usepackage[utf8]{inputenc}

\usepackage[T1]{fontenc}
\usepackage[top=2cm, bottom=2cm, left=3cm, right=2cm]{geometry}
\setcounter{secnumdepth}{3}
\setcounter{tocdepth}{3}
\usepackage{url}
\usepackage[round]{natbib}
\usepackage[a4paper=true, colorlinks=true, linkcolor=black,urlcolor=blue,citecolor=black]{hyperref}


\usepackage{colortbl, xcolor}
\usepackage{float}

\newcommand{\pack}{\texttt{PPBstats}}
\newcommand{\R}{\texttt{R}}
\newcommand{\versionnumber}{0.10.0}
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\begin{document}



\input{./sections/head}

\section{Philosophy of \pack}

\input{./sections/philo_pack}

\subsection{Let's go!}
To continue, load the package:
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{library}\hlstd{(PPBstats)}
\end{alltt}
\end{kframe}
\end{knitrout}
and download from internet the data used in this vignette (this is useful to earn lots of time!) here : \url{https://www.dropbox.com/sh/6qvl515k5484zg4/AADZKkaM2XZvmr9e6l5aWxN2a?dl=0} and put it in the folder \texttt{data\_PPBstats} and then load() it.

%The example in this vignette were performed with a computer with 4 Gb of memory and the following processor : Intel(R) Core(TM) i5-4210M CPU @ 2.60GHz.
%This gives an idea about memory and processor needed to run the analysis.

\section{At the farm level : model~\ref{model1} to perform mean comparisons on farms }
\label{section_model1}

\subsection{The model}
\input{./sections/model1}

\subsection{With \pack}

For model~\ref{model1}, you can follow these steps (Figure \ref{function_relations}):

\begin{enumerate}
\item Run the model with \texttt{MC}
\item Analyse model outputs with graphs to know if you can continue the analysis with \texttt{analyse.outputs}
\item Get mean comparisons for each factor with \texttt{get.mean.comparisons} and \texttt{get.ggplot}
\end{enumerate}



Let's get the data.
The values for $\mu_{ij}$, $\beta_{jk}$, $\epsilon_{ijk}$ and $\sigma_j$ are the real value taken to create the dataset.
This dataset is representative of data you can get in a PPB programme.

\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{data}\hlstd{(PPBdata)}
\hlkwd{head}\hlstd{(PPBdata)}
\end{alltt}
\begin{verbatim}
##   year location germplasm block X Y      tkw    mu_ij beta_jk
## 1 2010   env1-1     tem-1     1 1 a 72.09900 73.37224       0
## 2 2010   env1-1     tem-2     1 2 b 61.05274 61.61823       0
## 3 2010   env1-1     tem-3     1 3 c 62.99350 64.31830       0
## 4 2010   env1-1     tem-4     1 4 d 65.10909 62.57840       0
## 5 2010   env1-1     tem-1     2 5 e 77.01361 73.37224       0
## 6 2010   env1-1     tem-2     2 6 f 64.10541 61.61823       0
##   epsilon_ijk  sigma_j
## 1  -1.2732421 1.622339
## 2  -0.5654918 1.622339
## 3  -1.3248006 1.622339
## 4   2.5306946 1.622339
## 5   3.6413666 1.622339
## 6   2.4871807 1.622339
\end{verbatim}
\end{kframe}
\end{knitrout}

\subsubsection{Run the model}

To run model~\ref{model1} on the dataset, used the function \texttt{MC}.
You can run it on one variable.
Here it is thousand kernel weight (tkw).

By default, \texttt{MC} returns posteriors for 
$\mu_{ij}$ (\texttt{return.mu = TRUE}), 
$\beta_{jk}$ (\texttt{return.beta = TRUE}), 
$\sigma_j$ (\texttt{return.sigma = TRUE}), 
$\nu$ (\texttt{return.nu = TRUE}) and 
$\rho$ (\texttt{return.rho = TRUE}).
You can also get $\epsilon_{ijk}$ value with \texttt{return.espilon = TRUE}.

By default, DIC is not displayed, you may want this value to compare to other model (\texttt{DIC = TRUE}).
DIC criterion is a generalization of the AIC criterion that can be used for hierarchical models \citep{spiegelhalter_bayesian_2002}.
The smaller the DIC value, the better the model \citep{plummer_penalized_2008}.

\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlcom{# out.model1 = MC(data = PPBdata, variable = "tkw", return.epsilon = TRUE)}
\hlcom{#Compiling model graph}
\hlcom{#   Resolving undeclared variables}
\hlcom{#   Allocating nodes}
\hlcom{#   Graph Size: 7662}
\hlcom{#}
\hlcom{#Initializing model}
\hlcom{#}
\hlcom{#  |++++++++++++++++++++++++++++++++++++++++++++++++++| 100%}
\hlcom{#  |**************************************************| 100%}
\hlcom{#  |**************************************************| 100%}
\hlcom{#  |**************************************************| 100%}

\hlkwd{load}\hlstd{(}\hlstr{"./data_PPBstats/out.model1.RData"}\hlstd{)} \hlcom{# To save time}
\end{alltt}
\end{kframe}
\end{knitrout}

You can get informations of the environments in the dataset :

\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{out.model1}\hlopt{$}\hlstd{vec_env_with_no_data}
\end{alltt}
\begin{verbatim}
## [1] "env4:2011"
\end{verbatim}
\begin{alltt}
\hlstd{out.model1}\hlopt{$}\hlstd{vec_env_with_no_controls}
\end{alltt}
\begin{verbatim}
## [1] "env5:2010"
\end{verbatim}
\begin{alltt}
\hlstd{out.model1}\hlopt{$}\hlstd{vec_env_with_controls}
\end{alltt}
\begin{verbatim}
##  [1] "env1-1:2010"  "env1-1:2011"  "env1-1:2012"  "env1-2:2010" 
##  [5] "env1-2:2011"  "env1-2:2012"  "env1-3:2010"  "env1-3:2011" 
##  [9] "env1-3:2012"  "env1-4:2010"  "env1-4:2011"  "env1-4:2012" 
## [13] "env1-5:2011"  "env2-10:2010" "env2-10:2011" "env2-10:2012"
## [17] "env2-11:2011" "env2-11:2012" "env2-1:2010"  "env2-1:2011" 
## [21] "env2-1:2012"  "env2-12:2011" "env2-12:2012" "env2-13:2011"
## [25] "env2-13:2012" "env2-14:2011" "env2-14:2012" "env2-15:2011"
## [29] "env2-15:2012" "env2-2:2010"  "env2-2:2011"  "env2-2:2012" 
## [33] "env2-3:2010"  "env2-3:2011"  "env2-3:2012"  "env2-4:2010" 
## [37] "env2-4:2011"  "env2-4:2012"  "env2-5:2010"  "env2-5:2011" 
## [41] "env2-5:2012"  "env2-6:2010"  "env2-6:2011"  "env2-6:2012" 
## [45] "env2-7:2010"  "env2-7:2011"  "env2-7:2012"  "env2-8:2010" 
## [49] "env2-8:2011"  "env2-8:2012"  "env2-9:2010"  "env2-9:2011" 
## [53] "env2-9:2012"  "env3-1:2011"  "env3-1:2012"  "env3-2:2011" 
## [57] "env3-2:2012"  "env3-3:2011"
\end{verbatim}
\begin{alltt}
\hlstd{out.model1}\hlopt{$}\hlstd{vec_env_RF}
\end{alltt}
\begin{verbatim}
##  [1] "env1-1:2010" "env1-1:2011" "env1-1:2012" "env1-2:2010"
##  [5] "env1-2:2011" "env1-2:2012" "env1-3:2010" "env1-3:2011"
##  [9] "env1-3:2012" "env1-4:2010" "env1-4:2011" "env1-4:2012"
## [13] "env1-5:2011" "env3-1:2011" "env3-1:2012" "env3-2:2011"
## [17] "env3-2:2012" "env3-3:2011"
\end{verbatim}
\begin{alltt}
\hlstd{out.model1}\hlopt{$}\hlstd{vec_env_SF}
\end{alltt}
\begin{verbatim}
##  [1] "env2-10:2010" "env2-10:2011" "env2-10:2012" "env2-11:2011"
##  [5] "env2-11:2012" "env2-1:2010"  "env2-1:2011"  "env2-1:2012" 
##  [9] "env2-12:2011" "env2-12:2012" "env2-13:2011" "env2-13:2012"
## [13] "env2-14:2011" "env2-14:2012" "env2-15:2011" "env2-15:2012"
## [17] "env2-2:2010"  "env2-2:2011"  "env2-2:2012"  "env2-3:2010" 
## [21] "env2-3:2011"  "env2-3:2012"  "env2-4:2010"  "env2-4:2011" 
## [25] "env2-4:2012"  "env2-5:2010"  "env2-5:2011"  "env2-5:2012" 
## [29] "env2-6:2010"  "env2-6:2011"  "env2-6:2012"  "env2-7:2010" 
## [33] "env2-7:2011"  "env2-7:2012"  "env2-8:2010"  "env2-8:2011" 
## [37] "env2-8:2012"  "env2-9:2010"  "env2-9:2011"  "env2-9:2012"
\end{verbatim}
\end{kframe}
\end{knitrout}

\subsubsection{Analysis of the model outputs}
Once the model is run, it is necessary to check if the outputs can be taken with confidence.
This step is needed before going ahead in the analysis (in fact, the MCMC object used in the next functions must come from \texttt{analyse.outputs}!).

\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlcom{# The experimental design plot is done.}
\hlcom{# The Gelman-Rubin test is running for each parameter ...}
\hlcom{# The two MCMC for each parameter converge thanks to the Gelman-Rubin test.}
\hlcom{# The values of sigma in the inverse Gamme distribution are done.}
\hlcom{# The mu_ij posterior distributions are done.}
\hlcom{# The beta_jk posterior distributions are done.}
\hlcom{# The sigma_j posterior distributions are done.}
\hlcom{# The standardised residuals distributions are done.}

\hlkwd{load}\hlstd{(}\hlstr{"./data_PPBstats/out1.RData"}\hlstd{)}
\end{alltt}
\end{kframe}
\end{knitrout}

\texttt{out1} is a list containing:

\begin{itemize}

\item "experimental\_design" : a plot representing the presence/abscence matrix of G $\times$ E combinaisons. 
Here there are lots of 0 meaning that a lot of germplasm are no in at least two farms.
A score of 1 is for a given germplasm in a given environment.
A score of 2 is for a given germplasm replicated twice in a given environement.
A score of 3 is for a given germplasm replicated three times in a given environement.

\begin{figure}[H]
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{out1}\hlopt{$}\hlstd{data.experimental_design}\hlopt{$}\hlstd{plot}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=.6\textwidth]{figures/PPBstats_unnamed-chunk-6-1} 

}



\end{knitrout}
\end{figure}

\item "convergence" : a list with the plots of trace and density to check the convergence of the two MCMC only for chains that are not converging thanks to the Gelman-Rubin test \citep{gelman_inference_1992}. If all the chains converge, it is NULL

\begin{figure}[H]
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{out1}\hlopt{$}\hlstd{convergence}
\end{alltt}
\begin{verbatim}
## NULL
\end{verbatim}
\end{kframe}
\end{knitrout}
\end{figure}

Here all the parameters converge.
Below is an example where there is no convergence because the MCMC are too small.

\begin{figure}[H]
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlcom{# out.model1_bis = MC(data = PPBdata, variable = "tkw", nb_iteration = 5000)}
\hlcom{#Compiling model graph}
\hlcom{#   Resolving undeclared variables}
\hlcom{#   Allocating nodes}
\hlcom{#   Graph Size: 7662}
\hlcom{#}
\hlcom{#Initializing model}
\hlcom{#}
\hlcom{#  |++++++++++++++++++++++++++++++++++++++++++++++++++| 100%}
\hlcom{#  |**************************************************| 100%}
\hlcom{#  |**************************************************| 100%}
\hlcom{#Warning message:}
\hlcom{#In MC(data = PPBdata, variable = "tkw", nb_iteration = 5000) :}
\hlcom{#  nb_iterations is below 20 000, which seems small to get convergence in the MCMC.}

\hlkwd{load}\hlstd{(}\hlstr{"./data_PPBstats/out.model1_bis.RData"}\hlstd{)} \hlcom{# To save time}

\hlcom{# out1_bis = analyse.outputs(out.model1_bis)}
\hlcom{# The experimental design plot is done.}
\hlcom{# The Gelman-Rubin test is running for each parameter ...}
\hlcom{# The two MCMC of the following parameters do not converge thanks to the Gelman-Rubin test : }
\hlcom{# nu, rho, sigma[env1-1:2012], sigma[env1-2:2011], sigma[env2-12:2012], sigma[env2-6:2010]. }
\hlcom{# Therefore, they are not present in MCMC output.}
\hlcom{# MCMC are updated, the following environment were deleted : }
\hlcom{# env1-1:2012, env1-2:2011, env2-12:2012, env2-6:2010}
\hlcom{# model1.data_env_whose_param_did_not_converge contains the raw data for these environments.}
\hlcom{# The values of sigma in the inverse Gamme distribution are done.}
\hlcom{# The mu_ij posterior distributions are done.}
\hlcom{# The beta_jk posterior distributions are done.}
\hlcom{# The sigma_j posterior distributions are done.}

\hlkwd{load}\hlstd{(}\hlstr{"./data_PPBstats/out1_bis.RData"}\hlstd{)} \hlcom{# To save time}

\hlcom{# Get one example}
\hlstd{toplot} \hlkwb{=} \hlstd{out1_bis}\hlopt{$}\hlstd{convergence}\hlopt{$}\hlstr{"nu"}
\hlkwd{grid.arrange}\hlstd{(toplot}\hlopt{$}\hlstd{traceplot, toplot}\hlopt{$}\hlstd{density,} \hlkwc{ncol}\hlstd{=}\hlnum{2}\hlstd{,} \hlkwc{nrow}\hlstd{=}\hlnum{1}\hlstd{)}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=.6\textwidth]{figures/PPBstats_unnamed-chunk-8-1} 

}



\end{knitrout}
\end{figure}


\item "parameter\_posteriors" : a list with

\begin{itemize}

\item "sigma\_distribution" : the distribution of the sigma is displayed on the Inverse Gamma distribution

\begin{figure}[H]
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{out1}\hlopt{$}\hlstd{posteriors}\hlopt{$}\hlstd{sigma_distribution[[}\hlnum{1}\hlstd{]]} \hlcom{# All the values}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=.6\textwidth]{figures/PPBstats_unnamed-chunk-9-1} 

}



\end{knitrout}
\end{figure}


\begin{figure}[H]
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{out1}\hlopt{$}\hlstd{posteriors}\hlopt{$}\hlstd{sigma_distribution[[}\hlnum{12}\hlstd{]]} \hlcom{# A subset of values}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=.6\textwidth]{figures/PPBstats_unnamed-chunk-10-1} 

}



\end{knitrout}
\end{figure}


\item "parameter\_posteriors" : a caterpillar plot is display for each $\mu_{ij}$, $\beta_{jk}$ for a each environment and for $\sigma_j$.
Below is an example for environment env1-1:2010.
It is important to see it the values are coherent with your a priori knowledge.
Indeed, a model can converge and estimate parameters'value that are not coherent!

\begin{figure}[H]
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{out1}\hlopt{$}\hlstd{posteriors}\hlopt{$}\hlstd{parameter_posteriors}\hlopt{$}\hlstd{mu_posteriors}\hlopt{$}\hlstr{"env1-1:2010"}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=.6\textwidth]{figures/PPBstats_unnamed-chunk-11-1} 

}



\end{knitrout}
\end{figure}

\begin{figure}[H]
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{out1}\hlopt{$}\hlstd{posteriors}\hlopt{$}\hlstd{parameter_posteriors}\hlopt{$}\hlstd{beta_posteriors}\hlopt{$}\hlstr{"env1-1:2010"}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=.6\textwidth]{figures/PPBstats_unnamed-chunk-12-1} 

}



\end{knitrout}
\end{figure}

\begin{figure}[H]
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{out1}\hlopt{$}\hlstd{posteriors}\hlopt{$}\hlstd{parameter_posteriors}\hlopt{$}\hlstd{sigma_posteriors[[}\hlnum{1}\hlstd{]]}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=.6\textwidth]{figures/PPBstats_unnamed-chunk-13-1} 

}



\end{knitrout}
\end{figure}

\item "standardized\_residuals" : a plot to check the normality of the residuals. If the model went well it should be between -2 and 2.

\begin{figure}[H]
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{out1}\hlopt{$}\hlstd{posteriors}\hlopt{$}\hlstd{standardized_residuals}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=.6\textwidth]{figures/PPBstats_unnamed-chunk-14-1} 

}



\end{knitrout}
\end{figure}

\end{itemize}

\item "MCMC" : a data fame resulting from the concatenation of the two MCMC for each parameter. This object can be used for further analysis. There are as many columns than parameters and as many rows than iterations//thin (the thin value is 10 by default in the models).

\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{dim}\hlstd{(out1}\hlopt{$}\hlstd{MCMC)}
\end{alltt}
\begin{verbatim}
## [1] 20000   945
\end{verbatim}
\end{kframe}
\end{knitrout}

\end{itemize}

Just for fun, you can compare the posterior medians and the arithmetic means for the $\mu_{ij}$.

\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{MCMC} \hlkwb{=} \hlstd{out1}\hlopt{$}\hlstd{MCMC}
\hlstd{effects} \hlkwb{=} \hlkwd{apply}\hlstd{(MCMC,} \hlnum{2}\hlstd{, median)}
\hlstd{mu_ij_estimated} \hlkwb{=} \hlstd{effects[}\hlkwd{grep}\hlstd{(}\hlstr{"mu"}\hlstd{,}\hlkwd{names}\hlstd{(effects))]}
\hlkwd{names}\hlstd{(mu_ij_estimated)} \hlkwb{=} \hlkwd{sapply}\hlstd{(}\hlkwd{names}\hlstd{(mu_ij_estimated),}
                                \hlkwa{function}\hlstd{(}\hlkwc{x}\hlstd{)\{}  \hlkwd{sub}\hlstd{(}\hlstr{"\textbackslash{}\textbackslash{}]"}\hlstd{,} \hlstr{""}\hlstd{,} \hlkwd{sub}\hlstd{(}\hlstr{"mu\textbackslash{}\textbackslash{}["}\hlstd{,} \hlstr{""}\hlstd{, x)) \}}
                                \hlstd{)}

\hlstd{d} \hlkwb{=} \hlkwd{filter}\hlstd{(PPBdata, location} \hlopt{!=} \hlstr{"env4"}\hlstd{)}
\hlstd{d} \hlkwb{=} \hlkwd{filter}\hlstd{(d, location} \hlopt{!=} \hlstr{"env5"}\hlstd{)}
\hlstd{d} \hlkwb{=} \hlkwd{droplevels}\hlstd{(d)}
\hlstd{environment} \hlkwb{=} \hlkwd{paste}\hlstd{(}\hlkwd{as.character}\hlstd{(d}\hlopt{$}\hlstd{location),} \hlkwd{as.character}\hlstd{(d}\hlopt{$}\hlstd{year),} \hlkwc{sep} \hlstd{=} \hlstr{":"}\hlstd{)}
\hlstd{d}\hlopt{$}\hlstd{entry} \hlkwb{=} \hlkwd{as.factor}\hlstd{(}\hlkwd{paste}\hlstd{(}\hlkwd{as.character}\hlstd{(d}\hlopt{$}\hlstd{germplasm), environment,} \hlkwc{sep} \hlstd{=} \hlstr{","}\hlstd{))}
\hlstd{mu_ij} \hlkwb{=} \hlkwd{tapply}\hlstd{(d}\hlopt{$}\hlstd{mu_ij, d}\hlopt{$}\hlstd{entry, mean,} \hlkwc{na.rm} \hlstd{=} \hlnum{TRUE}\hlstd{)}

\hlstd{check} \hlkwb{=} \hlkwd{cbind.data.frame}\hlstd{(mu_ij, mu_ij_estimated[}\hlkwd{names}\hlstd{(mu_ij)])}
\end{alltt}
\end{kframe}
\end{knitrout}

Let's have a look on the relation between the posterior medians and the arithmetic means.
It goes pretty well!

\begin{figure}[H]
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{p} \hlkwb{=} \hlkwd{ggplot}\hlstd{(check,} \hlkwd{aes}\hlstd{(}\hlkwc{x} \hlstd{= mu_ij,} \hlkwc{y} \hlstd{= mu_ij_estimated))}
\hlstd{p} \hlopt{+} \hlkwd{stat_smooth}\hlstd{(}\hlkwc{method} \hlstd{=} \hlstr{"lm"}\hlstd{)} \hlopt{+} \hlkwd{geom_point}\hlstd{()}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=.6\textwidth]{figures/PPBstats_unnamed-chunk-17-1} 

}



\end{knitrout}
\end{figure}


\subsubsection{Get mean comparisons}

\input{./sections/mean_comp}


\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlcom{# comp.mu = get.mean.comparisons(out1$MCMC, "mu")}
\hlcom{# Get at least X groups for env2-1:2011. It may take some time ...}
\hlcom{# Get at least X groups for  env2-1:2011 is done.}
\hlcom{# Get at least X groups for env2-13:2011. It may take some time ...}
\hlcom{# Get at least X groups for  env2-13:2011 is done.}
\hlcom{# Get at least X groups for env2-3:2012. It may take some time ...}
\hlcom{# Get at least X groups for  env2-3:2012 is done.}
\hlcom{# Get at least X groups for env2-9:2010. It may take some time ...}
\hlcom{# Get at least X groups for  env2-9:2010 is done.}

\hlkwd{load}\hlstd{(}\hlstr{"./data_PPBstats/comp.mu.RData"}\hlstd{)} \hlcom{# To save time}
\end{alltt}
\end{kframe}
\end{knitrout}

To see the output, use \texttt{get.ggplot}.
On each plot, the \texttt{alpha} (type one error) value and the alpha correction are displayed.
\texttt{alpha = Imp} means that no differences were possible to find.
For \texttt{ggplot.type = "interaction"} and \texttt{ggplot.type = "score"}, it is display under the form: \texttt{alpha | alpha correction}.

\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{p_barplot} \hlkwb{=} \hlkwd{get.ggplot}\hlstd{(comp.mu,} \hlkwc{ggplot.type} \hlstd{=} \hlstr{"barplot"}\hlstd{)}
\hlkwd{names}\hlstd{(p_barplot)}
\end{alltt}
\begin{verbatim}
##  [1] "env1-1:2010"  "env1-1:2011"  "env1-1:2012"  "env1-2:2010" 
##  [5] "env1-2:2011"  "env1-2:2012"  "env1-3:2010"  "env1-3:2011" 
##  [9] "env1-3:2012"  "env1-4:2010"  "env1-4:2011"  "env1-4:2012" 
## [13] "env1-5:2011"  "env2-10:2010" "env2-10:2011" "env2-10:2012"
## [17] "env2-11:2011" "env2-11:2012" "env2-1:2010"  "env2-1:2011" 
## [21] "env2-1:2012"  "env2-12:2011" "env2-12:2012" "env2-13:2011"
## [25] "env2-13:2012" "env2-14:2011" "env2-14:2012" "env2-15:2011"
## [29] "env2-15:2012" "env2-2:2010"  "env2-2:2011"  "env2-2:2012" 
## [33] "env2-3:2010"  "env2-3:2011"  "env2-3:2012"  "env2-4:2010" 
## [37] "env2-4:2011"  "env2-4:2012"  "env2-5:2010"  "env2-5:2011" 
## [41] "env2-5:2012"  "env2-6:2010"  "env2-6:2011"  "env2-6:2012" 
## [45] "env2-7:2010"  "env2-7:2011"  "env2-7:2012"  "env2-8:2010" 
## [49] "env2-8:2011"  "env2-8:2012"  "env2-9:2010"  "env2-9:2011" 
## [53] "env2-9:2012"  "env3-1:2011"  "env3-1:2012"  "env3-2:2011" 
## [57] "env3-2:2012"  "env3-3:2011"
\end{verbatim}
\end{kframe}
\end{knitrout}

\begin{figure}[H]

\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlcom{# For environment env-1-1:2010}
\hlkwd{grid.arrange}\hlstd{(p_barplot}\hlopt{$}\hlstr{"env1-1:2010"}\hlstd{[[}\hlnum{1}\hlstd{]], p_barplot}\hlopt{$}\hlstr{"env1-1:2010"}\hlstd{[[}\hlnum{2}\hlstd{]] ,} \hlkwc{ncol} \hlstd{=} \hlnum{2}\hlstd{,} \hlkwc{nrow} \hlstd{=} \hlnum{1}\hlstd{)}
\hlkwd{grid.arrange}\hlstd{(p_barplot}\hlopt{$}\hlstr{"env1-1:2010"}\hlstd{[[}\hlnum{2}\hlstd{]], p_barplot}\hlopt{$}\hlstr{"env1-1:2010"}\hlstd{[[}\hlnum{4}\hlstd{]],} \hlkwc{ncol} \hlstd{=} \hlnum{2}\hlstd{,} \hlkwc{nrow} \hlstd{=} \hlnum{1}\hlstd{)}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=.6\textwidth]{figures/PPBstats_unnamed-chunk-20-1} 
\includegraphics[width=.6\textwidth]{figures/PPBstats_unnamed-chunk-20-2} 

}



\end{knitrout}
\end{figure}

With \texttt{ggplot.type = "interaction"}, you can display the year effect as well as detect groups.
One group is represented by one dashed line.
Germplasms which share the same group are not different.
Germplasms which do not share the same groupe are different (section \ref{mean_comp}).

\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{p_interaction} \hlkwb{=} \hlkwd{get.ggplot}\hlstd{(comp.mu,} \hlkwc{ggplot.type} \hlstd{=} \hlstr{"interaction"}\hlstd{)}
\end{alltt}
\end{kframe}
\end{knitrout}

\begin{figure}[H]
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlcom{# For location env-1-1.}
\hlstd{p_interaction}\hlopt{$}\hlstr{"env1-1"}\hlstd{[[}\hlnum{1}\hlstd{]]}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=.6\textwidth]{figures/PPBstats_unnamed-chunk-22-1} 

}



\end{knitrout}
\end{figure}

\begin{figure}[H]
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{p_interaction}\hlopt{$}\hlstr{"env1-1"}\hlstd{[[}\hlnum{2}\hlstd{]]}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=.6\textwidth]{figures/PPBstats_unnamed-chunk-23-1} 

}



\end{knitrout}
\end{figure}

\begin{figure}[H]
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{p_interaction}\hlopt{$}\hlstr{"env1-1"}\hlstd{[[}\hlnum{3}\hlstd{]]}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=.6\textwidth]{figures/PPBstats_unnamed-chunk-24-1} 

}



\end{knitrout}
\end{figure}
             
\begin{figure}[H]
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{p_interaction}\hlopt{$}\hlstr{"env1-1"}\hlstd{[[}\hlnum{4}\hlstd{]]}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=.6\textwidth]{figures/PPBstats_unnamed-chunk-25-1} 

}



\end{knitrout}
\end{figure}

For the score, more entries are displayed.
An high score means that the entry was in a group with an high mean.
A low socre means that the entry was in a group with an low mean.
This plot is useful to look at year effects.

\begin{figure}[H]
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{p_score} \hlkwb{=} \hlkwd{get.ggplot}\hlstd{(comp.mu,} \hlkwc{ggplot.type} \hlstd{=} \hlstr{"score"}\hlstd{,} \hlkwc{nb_parameters_per_plot} \hlstd{=} \hlnum{15}\hlstd{)}
\hlcom{# For location env-1-1}
\hlkwd{grid.arrange}\hlstd{(p_score}\hlopt{$}\hlstr{"env1-1"}\hlstd{[[}\hlnum{1}\hlstd{]], p_score}\hlopt{$}\hlstr{"env1-1"}\hlstd{[[}\hlnum{2}\hlstd{]] ,} \hlkwc{ncol} \hlstd{=} \hlnum{2}\hlstd{,} \hlkwc{nrow} \hlstd{=} \hlnum{1}\hlstd{)}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=.6\textwidth]{figures/PPBstats_unnamed-chunk-26-1} 

}



\end{knitrout}
\end{figure}

The same method is used for each $\beta_{jk}$.

\vspace{.5cm}

For environments with no controls or where at least one MCMC did not converge, it may be useful to get the plot as well.

\begin{figure}[H]
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{get.ggplot}\hlstd{(out.model1}\hlopt{$}\hlstd{data_env_with_no_controls,} \hlkwc{ggplot.type} \hlstd{=} \hlstr{"barplot"}\hlstd{)}
\end{alltt}
\begin{verbatim}
## $`env5:2010`
## $`env5:2010`$`1`
\end{verbatim}
\end{kframe}



{\centering \includegraphics[width=.6\textwidth]{figures/PPBstats_unnamed-chunk-27-1} 

}



\end{knitrout}
\end{figure}

You can also do a plot with interaction. 
Here it is not useful as there is only one year.

\begin{figure}[H]
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{g} \hlkwb{=} \hlkwd{get.ggplot}\hlstd{(out1_bis}\hlopt{$}\hlstd{model1.data_env_whose_param_did_not_converge,} \hlkwc{ggplot.type} \hlstd{=} \hlstr{"barplot"}\hlstd{)}

\hlkwd{names}\hlstd{(g)}
\end{alltt}
\begin{verbatim}
## [1] "env1-1:2012"  "env1-2:2011"  "env2-12:2012" "env2-6:2010"
\end{verbatim}
\begin{alltt}
\hlstd{g}\hlopt{$}\hlstd{`env1-1:2012`}\hlopt{$}\hlstd{`1`}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=.6\textwidth]{figures/PPBstats_unnamed-chunk-28-1} 

}



\end{knitrout}
\end{figure}


\section{At the network level : model~\ref{model2} to analyse $G \times E$ interaction in the network of farms }
\label{section_model2}

\subsection{The model}
\input{./sections/model2}

\subsection{With \pack}

For model~\ref{model2}, you can follow these steps (Figure \ref{function_relations}):

\begin{enumerate}
\item Run the model with \texttt{FWH}
\item Analyse model outputs with graphs to kow if you can continue the analysis with \texttt{analyse.outputs}
\item Perform cross validation studies with \texttt{cross.validation.FWH} in order to assess the quality of the model
\item Get mean comparisons for each factor with \texttt{get.mean.comparisons} and \texttt{get.ggplot}
\item Get groups of parameters for $\alpha$, $\beta$ and $\theta$ with \texttt{get.parameters.groups} and \texttt{get.ggplot}
\item Predict the past with \texttt{predict.the.past} and \texttt{get.ggplot}
\end{enumerate}

Let's get the data.
The values for $\alpha_i$, $\beta_i$, $\theta_j$ are the real value taken to create the dataset for y1.
This dataset is representative of data you can get in a PPB programme.

\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{data}\hlstd{(PPBdata2)}
\hlkwd{head}\hlstd{(PPBdata2)}
\end{alltt}
\begin{verbatim}
##   germplasm location   year        y1 alpha_i-1 beta_i-1  theta_j-1
## 1     geno1   loc-35 year-1  7.926204  10.25349 2.170004 -0.7776704
## 2     geno1   loc-48 year-1  9.772076  10.25349 2.170004 -0.7531355
## 3     geno1   loc-20 year-5  9.199745  10.25349 2.170004  0.1163468
## 4     geno1   loc-33 year-5 10.131745  10.25349 2.170004  0.2755013
## 5     geno1   loc-44 year-3 14.329280  10.25349 2.170004  1.8495949
## 6     geno1   loc-34 year-1  8.709140  10.25349 2.170004 -0.5750281
##         y2       y3 block X Y
## 1 18.28223 31.57931     1 1 1
## 2 18.41129 31.44957     1 2 2
## 3 18.94209 33.19169     1 3 3
## 4 24.86338 29.34573     1 4 4
## 5 16.09421 32.36811     1 5 5
## 6 17.93222 37.85269     1 6 6
\end{verbatim}
\end{kframe}
\end{knitrout}


\subsubsection{Run the model}

To run model \ref{model2} on the dataset, used the function \texttt{FWH} (which stands for Finlay Wilkinson Hierarchical).
You can run it on one variable.
Here it is on thousand kernel weight (tkw)

By default, \texttt{FWH} returns posteriors for 
$\alpha_i$ (\texttt{return.alpha = TRUE}),
$\sigma_{\alpha}$ (\texttt{return.sigma\_alpha = TRUE}),
$\beta_i$ (\texttt{return.beta = TRUE}),
$\sigma_{\beta}$ (\texttt{return.sigma\_beta = TRUE}),
$\theta_j$ (\texttt{return.theta = TRUE}),
$\sigma_{\theta}$ (\texttt{return.sigma\_theta = TRUE}) and
$\sigma_{\epsilon}$ (\texttt{return.sigma\_epsilon = TRUE}).
You can also get $\epsilon_{ij}$ with \texttt{return.epsilon = TRUE}.

By default, DIC is not display, you may want this value to compare to other model (\texttt{DIC = TRUE}).
DIC criterion is a generalization of the AIC criterion that can be used for hierarchical models \citep{spiegelhalter_bayesian_2002}.
The smaller the DIC value, the better the model \citep{plummer_penalized_2008}.

\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlcom{# out.model2 = FWH(data = PPBdata2, variable = "y1", return.epsilon = TRUE)}
\hlcom{#Run additive model ...}
\hlcom{#Compiling model graph}
\hlcom{#   Resolving undeclared variables}
\hlcom{#   Allocating nodes}
\hlcom{#   Graph Size: 9759}
\hlcom{#}
\hlcom{#Initializing model}
\hlcom{#}
\hlcom{#  |++++++++++++++++++++++++++++++++++++++++++++++++++| 100%}
\hlcom{#  |**************************************************| 100%}
\hlcom{#  |**************************************************| 100%}
\hlcom{#Run FWH model ...}
\hlcom{#Compiling model graph}
\hlcom{#   Resolving undeclared variables}
\hlcom{#   Allocating nodes}
\hlcom{#   Graph Size: 14677}
\hlcom{#}
\hlcom{#Initializing model}
\hlcom{#}
\hlcom{#  |++++++++++++++++++++++++++++++++++++++++++++++++++| 100%}
\hlcom{#  |**************************************************| 100%}
\hlcom{#  |**************************************************| 100%}
\hlcom{#  |**************************************************| 100%}

\hlkwd{load}\hlstd{(}\hlstr{"./data_PPBstats/out.model2.RData"}\hlstd{)} \hlcom{# To save time}
\end{alltt}
\end{kframe}
\end{knitrout}

It may be useful to see which germplasm were not use in the analysis because they were in only one environment.

\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{out.model2}\hlopt{$}\hlstd{germplasm.not.used}
\end{alltt}
\begin{verbatim}
## NULL
\end{verbatim}
\end{kframe}
\end{knitrout}

\subsubsection{Analysis of model outputs}

Once the model is run, it is necessary to check if the outputs can be taken with confidence. 
This step is needed before going ahead in the analysis (in fact, the MCMC object used in the next functions must come from \texttt{analyse.outputs}!).


\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlcom{# out2 = analyse.outputs(out.model2)}
\hlcom{# The experimental design plot is done.}
\hlcom{# The Gelman-Rubin test is running for each parameter ...}
\hlcom{# The two MCMC for each parameter converge thanks to the Gelman-Rubin test.}
\hlcom{# The alpha_i posterior distributions are done.}
\hlcom{# The beta_i posterior distributions are done.}
\hlcom{# The theta_j posterior distributions are done.}
\hlcom{# The standardised residuals distributions are done.}

\hlkwd{load}\hlstd{(}\hlstr{"./data_PPBstats/out2.RData"}\hlstd{)} \hlcom{# To save time}
\end{alltt}
\end{kframe}
\end{knitrout}

\texttt{out2} is a list containing :

\begin{itemize}

\item "experimental\_design" : a plot representing the presence/abscence matrix of G $\times$ E combinaisons. 
Note that it displays only germplasms that are on at least two environments.

\begin{figure}[H]
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{out2}\hlopt{$}\hlstd{data.experimental_design}\hlopt{$}\hlstd{plot}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=.6\textwidth]{figures/PPBstats_unnamed-chunk-33-1} 

}



\end{knitrout}
\end{figure}

\item "convergence" : a list with the plots of trace and density to check the convergence of the two MCMC only for chains that are not converging thanks to the Gelman-Rubin test \citep{gelman_inference_1992}. If all the chains converge, it is NULL

\begin{figure}[H]
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{out2}\hlopt{$}\hlstd{convergence}
\end{alltt}
\begin{verbatim}
## NULL
\end{verbatim}
\end{kframe}
\end{knitrout}
\end{figure}

\item "parameter\_posteriors": a list with caterpillar plot for each $\alpha_i$, $\beta_i$ and $\theta_j$.

Below an example for $\alpha_i$.

\begin{figure}[H]
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{p} \hlkwb{=} \hlstd{out2}\hlopt{$}\hlstd{posteriors}\hlopt{$}\hlstd{parameter_posteriors}\hlopt{$}\hlstd{alpha_posteriors}
\hlkwd{grid.arrange}\hlstd{(p[[}\hlnum{1}\hlstd{]], p[[}\hlnum{2}\hlstd{]],}\hlkwc{ncol} \hlstd{=} \hlnum{2}\hlstd{,} \hlkwc{nrow} \hlstd{=} \hlnum{1}\hlstd{)}
\hlkwd{grid.arrange}\hlstd{(p[[}\hlnum{3}\hlstd{]], p[[}\hlnum{4}\hlstd{]],}\hlkwc{ncol} \hlstd{=} \hlnum{2}\hlstd{,} \hlkwc{nrow} \hlstd{=} \hlnum{1}\hlstd{)}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=.6\textwidth]{figures/PPBstats_unnamed-chunk-35-1} 
\includegraphics[width=.6\textwidth]{figures/PPBstats_unnamed-chunk-35-2} 

}



\end{knitrout}
\end{figure}


\item "standardized\_residuals" : a plot to check the normality of the residuals. If the model went well it should be between -2 and 2.

\begin{figure}[H]
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{out2}\hlopt{$}\hlstd{posteriors}\hlopt{$}\hlstd{standardized_residuals}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=.6\textwidth]{figures/PPBstats_unnamed-chunk-36-1} 

}



\end{knitrout}
\end{figure}

\item "MCMC": a data fame resulting from the concatenation of the two MCMC for each parameter. This object can be used for further analysis. There are as many columns than parameters and as many rows than iterations/thin (the thin value is 10 by default in the models).

\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{dim}\hlstd{(out2}\hlopt{$}\hlstd{MCMC)}
\end{alltt}
\begin{verbatim}
## [1] 20000   385
\end{verbatim}
\end{kframe}
\end{knitrout}

\end{itemize}

Just for fun, you compare the posterior medians and the arithmetic means for the $\alpha_i$'s.

\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{MCMC} \hlkwb{=} \hlstd{out2}\hlopt{$}\hlstd{MCMC}
\hlstd{effects} \hlkwb{=} \hlkwd{apply}\hlstd{(MCMC,} \hlnum{2}\hlstd{, median)}
\hlstd{alpha_i_estimated} \hlkwb{=} \hlstd{effects[}\hlkwd{grep}\hlstd{(}\hlstr{"alpha\textbackslash{}\textbackslash{}["}\hlstd{,}\hlkwd{names}\hlstd{(effects))]}
\hlkwd{names}\hlstd{(alpha_i_estimated)} \hlkwb{=} \hlkwd{sapply}\hlstd{(}\hlkwd{names}\hlstd{(alpha_i_estimated),} \hlkwa{function}\hlstd{(}\hlkwc{x}\hlstd{)\{}
\hlkwd{sub}\hlstd{(}\hlstr{"\textbackslash{}\textbackslash{}]"}\hlstd{,} \hlstr{""}\hlstd{,} \hlkwd{sub}\hlstd{(}\hlstr{"alpha\textbackslash{}\textbackslash{}["}\hlstd{,} \hlstr{""}\hlstd{, x)) \} )}

\hlstd{alpha_i} \hlkwb{=} \hlkwd{tapply}\hlstd{(PPBdata2}\hlopt{$}\hlstd{alpha_i, PPBdata2}\hlopt{$}\hlstd{germplasm, mean,} \hlkwc{na.rm} \hlstd{=} \hlnum{TRUE}\hlstd{)}

\hlstd{check} \hlkwb{=} \hlkwd{cbind.data.frame}\hlstd{(}\hlkwc{alpha_i} \hlstd{= alpha_i,} \hlkwc{alpha_i_estimated} \hlstd{= alpha_i_estimated[}\hlkwd{names}\hlstd{(alpha_i)])}
\end{alltt}
\end{kframe}
\end{knitrout}

Letâ€™s have a look at the relation between both values.

\begin{figure}[H]
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{p} \hlkwb{=} \hlkwd{ggplot}\hlstd{(check,} \hlkwd{aes}\hlstd{(}\hlkwc{x} \hlstd{= alpha_i,} \hlkwc{y} \hlstd{= alpha_i_estimated))}
\hlstd{p} \hlopt{+} \hlkwd{stat_smooth}\hlstd{(}\hlkwc{method} \hlstd{=} \hlstr{"lm"}\hlstd{)} \hlopt{+} \hlkwd{geom_point}\hlstd{()}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=.6\textwidth]{figures/PPBstats_unnamed-chunk-39-1} 

}



\end{knitrout}
\end{figure}


\subsubsection{Perform cross validation studies}

This step is useful to assess the quality of the model.
This step is higly computing consuming as the FWH model is run as many time as there is value of $Y_{ij}$ (i.e. number of rows of the data set).

The complete cross validation is done with \texttt{cross.validation.FWH}: 
each Value of $Y_{ij}$ is estimated by the entire data set without this value.

The convergence is not check for each validation. 
If the parameters in the FWH converge, then it is assumed that the FWH in the cross validation converge as well.

The model is run on dataset where germplasms are in three environments at least so the smallest data set where the cross valisation is run has germplasms present in two environments at least. 

You may parallelise to gain time with the \texttt{mc.cores} argument of the function.

The number of iterations is set to 100 000 but you can change it with the \texttt{nb\_iterations} argument.

The percentage of confidence is calculated with a t-test:

\begin{displaymath}
t = \frac{m - 0}{s/\sqrt{N}}
\end{displaymath}
with,

$N$ the number of observations in the data set,

$m = \frac{1}{N} \sum\limits_{n=1}^N Y_{n} - \hat{Y_{n}}$, the average bias

$s = \sqrt{\frac{1}{N-1} \sum\limits_{n=1}^N (Y_{n} - \hat{Y_{n}})^2}$, the standard deviation of the bias

$t$ follows a Student distribution with $N-1$ degree of freedom.

The percentage of confidence (i.e. the probability $H0$: the bias is equal to zero) comes from this distribution.

A regression is also done between estimated and observed value.

Here it is bad as only 10 iterations have been done to save computing time ...

\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlcom{# out.cv = cross.validation.FWH(data = PPBdata2, variable = "y1", nb_iterations = 10)}
\hlkwd{load}\hlstd{(}\hlstr{"./data_PPBstats/out.cv.RData"}\hlstd{)} \hlcom{# to save lots of time}
\end{alltt}
\end{kframe}
\end{knitrout}

\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{out.cv}\hlopt{$}\hlstd{percentage.of.confidence}
\end{alltt}
\begin{verbatim}
## [1] 6.7
\end{verbatim}
\end{kframe}
\end{knitrout}

\begin{figure}[H]
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{out.cv}\hlopt{$}\hlstd{regression}
\end{alltt}
\begin{verbatim}
## $plot
\end{verbatim}


{\ttfamily\noindent\color{warningcolor}{\#\# Warning in loop\_apply(n, do.ply): Removed 1 rows containing missing values (stat\_smooth).}}

{\ttfamily\noindent\color{warningcolor}{\#\# Warning in loop\_apply(n, do.ply): Removed 1 rows containing missing values (geom\_point).}}\begin{verbatim}
## 
## $anova
## 
## Call:
## lm(formula = real.value ~ estimated.value)
## 
## Coefficients:
##     (Intercept)  estimated.value  
##          6.8640           0.3275
\end{verbatim}
\end{kframe}

{\centering \includegraphics[width=.6\textwidth]{figures/PPBstats_unnamed-chunk-42-1} 

}



\end{knitrout}
\end{figure}



\subsubsection{Get mean comparisons}
For mean comparisons of parameters, it is the same method that presented in section \ref{mean_comp}.

\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{comp.alpha} \hlkwb{=} \hlkwd{get.mean.comparisons}\hlstd{(out2}\hlopt{$}\hlstd{MCMC,} \hlstr{"alpha"}\hlstd{)}
\hlstd{comp.theta} \hlkwb{=} \hlkwd{get.mean.comparisons}\hlstd{(out2}\hlopt{$}\hlstd{MCMC,} \hlstr{"theta"}\hlstd{)}
\hlstd{comp.beta} \hlkwb{=} \hlkwd{get.mean.comparisons}\hlstd{(out2}\hlopt{$}\hlstd{MCMC,} \hlstr{"beta"}\hlstd{,} \hlkwc{type} \hlstd{=} \hlnum{2}\hlstd{,} \hlkwc{threshold} \hlstd{=} \hlnum{1}\hlstd{)}
\end{alltt}
\end{kframe}
\end{knitrout}

To see the output, use \texttt{get.ggplot}.

\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{p_barplot} \hlkwb{=} \hlkwd{get.ggplot}\hlstd{(comp.alpha,} \hlkwc{ggplot.type} \hlstd{=} \hlstr{"barplot"}\hlstd{)}
\end{alltt}
\end{kframe}
\end{knitrout}

Lets' have a look at the firt values of $\alpha_i$.

\begin{figure}[H]
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{grid.arrange}\hlstd{(p_barplot}\hlopt{$}\hlstr{"alpha"}\hlstd{[[}\hlnum{1}\hlstd{]], p_barplot}\hlopt{$}\hlstr{"alpha"}\hlstd{[[}\hlnum{2}\hlstd{]] ,} \hlkwc{ncol} \hlstd{=} \hlnum{2}\hlstd{,} \hlkwc{nrow} \hlstd{=} \hlnum{1}\hlstd{)}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=.6\textwidth]{figures/PPBstats_unnamed-chunk-45-1} 

}



\end{knitrout}
\end{figure}


\subsubsection{Get groups of parameters}

In order to cluster environments or germplasms, you may use mulivariate analysis on a matrix with several variables in columns and parameter in rows.

This is done with \texttt{get.parameter.groups} which do a PCA on this matrix and then find cluster with the \texttt{HCPC} procedure from package \texttt{FactoMineR}: it is a K-means clustering that creates clusters of similar parameters \citep{husson_principal_2010}.
The Kmeans clustering was done on the first two axes of the PCA that represented the main information while the last axes represented mainly noise \citep{husson_principal_2010}.
The number of clusters is choosen to maximise the variance between clusters and within clusters.
For more information type \texttt{?get.parameter.groups}.

\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlcom{# out.model2_y1 = FWH(PPBdata2, variable = "y1")}
\hlkwd{load}\hlstd{(}\hlstr{"./data_PPBstats/out.model2_y1.RData"}\hlstd{)} \hlcom{# to save time}

\hlcom{# out.model2_y2 = FWH(PPBdata2, variable = "y2")}
\hlkwd{load}\hlstd{(}\hlstr{"./data_PPBstats/out.model2_y2.RData"}\hlstd{)} \hlcom{# to save time}

\hlcom{# out.model2_y3 = FWH(PPBdata2, variable = "y3")}
\hlkwd{load}\hlstd{(}\hlstr{"./data_PPBstats/out.model2_y3.RData"}\hlstd{)} \hlcom{# to save time}

\hlstd{out2_y1} \hlkwb{=} \hlkwd{analyse.outputs}\hlstd{(out.model2_y1)}
\end{alltt}


{\ttfamily\noindent\itshape\color{messagecolor}{\#\# The experimental design plot is done.\\\#\# The Gelman-Rubin test is running for each parameter ...\\\#\# The two MCMC for each parameter converge thanks to the Gelman-Rubin test.\\\#\# The alpha\_i posterior distributions are done.\\\#\# The beta\_i posterior distributions are done.\\\#\# The theta\_j posterior distributions are done.}}\begin{alltt}
\hlstd{out2_y2} \hlkwb{=} \hlkwd{analyse.outputs}\hlstd{(out.model2_y2)}
\end{alltt}


{\ttfamily\noindent\itshape\color{messagecolor}{\#\# The experimental design plot is done.\\\#\# The Gelman-Rubin test is running for each parameter ...\\\#\# The two MCMC for each parameter converge thanks to the Gelman-Rubin test.\\\#\# The alpha\_i posterior distributions are done.\\\#\# The beta\_i posterior distributions are done.\\\#\# The theta\_j posterior distributions are done.}}\begin{alltt}
\hlstd{out2_y3} \hlkwb{=} \hlkwd{analyse.outputs}\hlstd{(out.model2_y3)}
\end{alltt}


{\ttfamily\noindent\itshape\color{messagecolor}{\#\# The experimental design plot is done.\\\#\# The Gelman-Rubin test is running for each parameter ...\\\#\# The two MCMC for each parameter converge thanks to the Gelman-Rubin test.\\\#\# The alpha\_i posterior distributions are done.\\\#\# The beta\_i posterior distributions are done.\\\#\# The theta\_j posterior distributions are done.}}\begin{alltt}
\hlstd{analyse.outputs.list} \hlkwb{=} \hlkwd{list}\hlstd{(}\hlkwc{var1} \hlstd{= out2_y1,} \hlkwc{var2} \hlstd{= out2_y2,} \hlkwc{var3} \hlstd{= out2_y3)}

\hlstd{clust} \hlkwb{=} \hlkwd{get.parameter.groups}\hlstd{(analyse.outputs.list,} \hlkwc{parameter} \hlstd{=} \hlstr{"theta"}\hlstd{)}
\end{alltt}
\end{kframe}
\end{knitrout}

To see the output, use \texttt{get.ggplot}.
A farmer may find a germplasm that behaves well according to informations from model \ref{model1} (section \ref{section_model1}) in a farm that shares its cluster.

\begin{figure}[H]
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{p_PCA} \hlkwb{=} \hlkwd{get.ggplot}\hlstd{(clust,} \hlkwc{ggplot.type} \hlstd{=} \hlstr{"PCA"}\hlstd{)}
\hlstd{p_PCA}
\end{alltt}
\begin{verbatim}
## $ind
## 
## $var
\end{verbatim}
\end{kframe}


{\centering \includegraphics[width=.6\textwidth]{figures/PPBstats_unnamed-chunk-47-1} 
\includegraphics[width=.6\textwidth]{figures/PPBstats_unnamed-chunk-47-2} 

}



\end{knitrout}
\end{figure}



\subsubsection{Predict the past}

In order to choose a new germplasm to test on his farm, a farmer may choose a germplasm according to the value it would have obtained on his farm.

You may either get the estimated MCMC, but you will need lots of memory, or the summary statistics of the MCMC.

Due to memory issues, it may be better to choose output.format = "summary".
This allows caterpillar plots but no mean comparisons that are base on the whole MCMC.

\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlcom{# out.predict.the.past = predict.the.past(out2, output.format = "summary")}
\hlcom{# |==========================================================| 100%}
\hlkwd{load}\hlstd{(}\hlstr{"./data_PPBstats/out.predict.the.past.RData"}\hlstd{)} \hlcom{# to save time}
\hlkwd{dim}\hlstd{(out.predict.the.past)}
\end{alltt}
\begin{verbatim}
## [1] 8140    8
\end{verbatim}
\end{kframe}
\end{knitrout}


If you choose \texttt{output.format = "summary"}, it is possible to look at the results with \texttt{get.ggplot}.


\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{p_barplot_predict} \hlkwb{=} \hlkwd{get.ggplot}\hlstd{(out.predict.the.past,} \hlkwc{ggplot.type} \hlstd{=} \hlstr{"barplot"}\hlstd{,}
                               \hlkwc{nb_parameters_per_plot} \hlstd{=} \hlnum{30}\hlstd{)}
\hlstd{p_barplot_predict}\hlopt{$}\hlstd{`loc-11:year-1`}\hlopt{$}\hlstd{`1`}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=.6\textwidth]{figures/PPBstats_unnamed-chunk-49-1} 

}



\end{knitrout}

\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{p_interaction_predict} \hlkwb{=} \hlkwd{get.ggplot}\hlstd{(out.predict.the.past,} \hlkwc{ggplot.type} \hlstd{=} \hlstr{"interaction"}\hlstd{)}
\hlstd{p_interaction_predict}\hlopt{$}\hlstd{`loc-46`}\hlopt{$}\hlstd{`1`}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=.6\textwidth]{figures/PPBstats_unnamed-chunk-50-1} 

}



\end{knitrout}



\newpage

\section*{To cite \pack} \addcontentsline{toc}{section}{To cite \pack}
To cite this package and or this vignette:

\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{citation}\hlstd{(}\hlstr{"PPBstats"}\hlstd{)}
\end{alltt}
\begin{verbatim}
## 
## To cite package 'PPBstats' in publications use:
## 
##   Pierre Riviere (2016). PPBstats: An R package for
##   statistical analysis of unbalanced trials in decentralized
##   participatory plant breeding programmes. R package version
##   0.10.0. http://github.com/priviere/PPBstats
## 
## A BibTeX entry for LaTeX users is
## 
##   @Manual{,
##     title = {PPBstats: An R package for statistical analysis of unbalanced trials in decentralized participatory plant breeding programmes},
##     author = {Pierre Riviere},
##     year = {2016},
##     note = {R package version 0.10.0},
##     url = {http://github.com/priviere/PPBstats},
##   }
\end{verbatim}
\end{kframe}
\end{knitrout}


\input{./sections/tail}

\end{document}

